# QueryHub Provider Configuration
# 
# This file defines:
# 1. Credentials - reusable authentication configurations organized by cloud provider
# 2. Providers - data sources that reference credentials by ID
#
# Credentials are organized by cloud provider (azure, aws, gcp) or generic type (postgresql, mysql, etc.)
# Providers reference credentials by ID for reusability across multiple resources

# ============================================================================
# CREDENTIALS
# ============================================================================
credentials:
  # Azure credentials
  - id: azure_default_credentials
    azure:
      type: default_credentials
      # Uses DefaultAzureCredential chain (environment, managed identity, Azure CLI, etc.)
  
  - id: azure_managed_identity
    azure:
      type: managed_identity
      client_id: ${ADX_CLIENT_ID:}
      # For user-assigned managed identities in Azure
  
  - id: azure_service_principal
    azure:
      type: service_principal
      client_id: ${AZURE_CLIENT_ID}
      client_secret: ${AZURE_CLIENT_SECRET}
      tenant_id: ${AZURE_TENANT_ID}
      # For service principal authentication
  
  - id: azure_token
    azure:
      type: token
      token: ${AZURE_TOKEN}
      # For direct bearer token authentication

  # AWS credentials
  - id: aws_default_credentials
    aws:
      type: default_credentials
      # Uses default AWS credential chain (environment, config files, IAM role, etc.)
  
  - id: aws_access_key
    aws:
      type: access_key
      access_key_id: ${AWS_ACCESS_KEY_ID}
      secret_access_key: ${AWS_SECRET_ACCESS_KEY}
      session_token: ${AWS_SESSION_TOKEN:}
      region: ${AWS_REGION:us-east-1}
  
  - id: aws_iam_role
    aws:
      type: iam_role
      role_arn: ${AWS_ROLE_ARN}
      session_name: ${AWS_SESSION_NAME:queryhub-session}
      region: ${AWS_REGION:us-east-1}

  # GCP credentials
  - id: gcp_default_credentials
    gcp:
      type: default_credentials
      project_id: ${GCP_PROJECT_ID}
      # Uses Application Default Credentials (ADC)
  
  - id: gcp_service_account
    gcp:
      type: service_account
      service_account_json: ${GCP_SERVICE_ACCOUNT_JSON}
      project_id: ${GCP_PROJECT_ID}

  # Generic credentials (PostgreSQL, MySQL, etc.)
  - id: postgres_reporting_credentials
    postgresql:
      type: username_password
      username: ${POSTGRES_USER:reporter}
      password: ${POSTGRES_PASSWORD:reportpw}
  
  - id: mysql_analytics_credentials
    mysql:
      type: username_password
      username: ${MYSQL_USER:analytics}
      password: ${MYSQL_PASSWORD:analyticspw}
  
  - id: rest_api_token
    generic:
      type: token
      token: ${API_TOKEN:demo-token}
      header_name: Authorization
      template: "Bearer {token}"
  
  - id: rest_api_basic_auth
    generic:
      type: username_password
      username: ${API_USERNAME}
      password: ${API_PASSWORD}
  
  - id: csv_no_credentials
    generic:
      type: no_credential
      # For resources that don't require authentication

# ============================================================================
# PROVIDERS
# ============================================================================
providers:
  # Azure Data Explorer (Kusto)
  - id: adx_marketing
    resource:
      adx:
        cluster_uri: https://help.kusto.windows.net
        database: Samples
        default_timeout_seconds: 60
        retry_attempts: 2
    credentials: azure_default_credentials
  
  - id: adx_production
    resource:
      adx:
        cluster_uri: ${ADX_CLUSTER_URI}
        database: ${ADX_DATABASE}
        default_timeout_seconds: 120
        retry_attempts: 3
    credentials: azure_managed_identity

  # PostgreSQL
  - id: postgres_reporting
    resource:
      sql:
        dsn: postgresql+asyncpg://${POSTGRES_HOST:localhost}:${POSTGRES_PORT:5432}/${POSTGRES_DB:reporting}
        options:
          application_name: queryhub
          pool_size: 5
          max_overflow: 10
    credentials: postgres_reporting_credentials
  
  # MySQL
  - id: mysql_analytics
    resource:
      sql:
        dsn: mysql+aiomysql://${MYSQL_HOST:localhost}:${MYSQL_PORT:3306}/${MYSQL_DB:analytics}
        options:
          application_name: queryhub
    credentials: mysql_analytics_credentials

  # REST API
  - id: rest_weather
    resource:
      rest:
        base_url: https://api.open-meteo.com/v1/
        default_headers:
          Accept: application/json
        request_options:
          raise_for_status: false
          timeout: 30
    credentials: rest_api_token
  
  - id: rest_internal_api
    resource:
      rest:
        base_url: ${INTERNAL_API_URL}
        default_headers:
          Accept: application/json
          Content-Type: application/json
    credentials: rest_api_basic_auth

  # CSV
  - id: csv_local
    resource:
      csv:
        root_path: data
        delimiter: ","
        quotechar: '"'
    credentials: csv_no_credentials
  
  - id: csv_exports
    resource:
      csv:
        root_path: /exports
        delimiter: ";"
        encoding: utf-8
    credentials: csv_no_credentials
