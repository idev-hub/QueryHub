# =============================================================================
# Weekly Executive Dashboard Example
# Multi-source report combining database, API, and CSV data
# =============================================================================

id: weekly_executive_dashboard
title: Weekly Executive Dashboard
description: Comprehensive weekly performance across all business metrics

template: report.html.j2

components:
  # ---------------------------------------------------------------------------
  # KEY METRICS SUMMARY
  # ---------------------------------------------------------------------------
  - id: kpi_summary
    title: Key Performance Indicators
    description: Week-over-week KPI comparison
    provider: postgres_analytics
    query:
      text: |
        WITH current_week AS (
          SELECT 
            SUM(revenue) as revenue,
            COUNT(DISTINCT customer_id) as customers,
            COUNT(*) as orders,
            AVG(satisfaction_score) as satisfaction
          FROM metrics
          WHERE week = DATE_TRUNC('week', CURRENT_DATE)
        ),
        previous_week AS (
          SELECT 
            SUM(revenue) as revenue,
            COUNT(DISTINCT customer_id) as customers,
            COUNT(*) as orders,
            AVG(satisfaction_score) as satisfaction
          FROM metrics
          WHERE week = DATE_TRUNC('week', CURRENT_DATE - INTERVAL '7 days')
        )
        SELECT 
          c.revenue as current_revenue,
          p.revenue as previous_revenue,
          ROUND(((c.revenue - p.revenue) / p.revenue) * 100, 2) as revenue_change_pct,
          c.customers as current_customers,
          p.customers as previous_customers,
          c.orders as current_orders,
          p.orders as previous_orders,
          ROUND(c.satisfaction, 2) as current_satisfaction,
          ROUND(p.satisfaction, 2) as previous_satisfaction
        FROM current_week c, previous_week p
    render:
      type: table
      options:
        columns: 
          - current_revenue
          - revenue_change_pct
          - current_customers
          - current_orders
          - current_satisfaction
        headers:
          current_revenue: Revenue
          revenue_change_pct: Change %
          current_customers: Active Customers
          current_orders: Orders
          current_satisfaction: Satisfaction

  # ---------------------------------------------------------------------------
  # REVENUE TREND (DATABASE)
  # ---------------------------------------------------------------------------
  - id: revenue_trend
    title: 12-Week Revenue Trend
    description: Weekly revenue over the past 12 weeks
    provider: postgres_analytics
    query:
      text: |
        SELECT 
          TO_CHAR(week, 'YYYY-MM-DD') as week,
          SUM(revenue) as revenue,
          COUNT(DISTINCT customer_id) as customers
        FROM metrics
        WHERE week >= DATE_TRUNC('week', CURRENT_DATE - INTERVAL '12 weeks')
        GROUP BY week
        ORDER BY week
    render:
      type: chart
      options:
        chart_type: line
        x_field: week
        y_field: revenue
        title: Weekly Revenue Trend
        x_label: Week
        y_label: Revenue ($)

  # ---------------------------------------------------------------------------
  # CUSTOMER ACQUISITION (DATABASE)
  # ---------------------------------------------------------------------------
  - id: customer_acquisition
    title: Customer Acquisition
    description: New vs returning customers this week
    provider: postgres_analytics
    query:
      text: |
        SELECT 
          customer_type,
          COUNT(*) as count,
          SUM(revenue) as revenue
        FROM (
          SELECT 
            customer_id,
            CASE 
              WHEN MIN(order_date) >= DATE_TRUNC('week', CURRENT_DATE) 
              THEN 'New' 
              ELSE 'Returning' 
            END as customer_type,
            SUM(amount) as revenue
          FROM orders
          WHERE order_date >= DATE_TRUNC('week', CURRENT_DATE)
          GROUP BY customer_id
        ) t
        GROUP BY customer_type
    render:
      type: chart
      options:
        chart_type: pie
        label_field: customer_type
        value_field: count
        title: Customer Distribution

  # ---------------------------------------------------------------------------
  # PRODUCT PERFORMANCE (DATABASE)
  # ---------------------------------------------------------------------------
  - id: product_performance
    title: Top 15 Products by Revenue
    description: Best-performing products this week
    provider: postgres_analytics
    query:
      text: |
        SELECT 
          product_name,
          SUM(quantity) as units_sold,
          SUM(revenue) as total_revenue,
          ROUND(AVG(price), 2) as avg_price
        FROM product_sales
        WHERE sale_date >= DATE_TRUNC('week', CURRENT_DATE)
        GROUP BY product_name
        ORDER BY total_revenue DESC
        LIMIT 15
    render:
      type: chart
      options:
        chart_type: bar
        x_field: product_name
        y_field: total_revenue
        title: Top Products This Week
        x_label: Product
        y_label: Revenue ($)

  # ---------------------------------------------------------------------------
  # MARKETING CAMPAIGN PERFORMANCE (CSV)
  # ---------------------------------------------------------------------------
  - id: campaign_performance
    title: Marketing Campaign Performance
    description: Current campaign metrics
    provider: csv_marketing
    query:
      path: campaigns_weekly.csv
    render:
      type: table
      options:
        columns: 
          - campaign_name
          - impressions
          - clicks
          - conversions
          - cost
          - revenue
        headers:
          campaign_name: Campaign
          impressions: Impressions
          clicks: Clicks
          conversions: Conversions
          cost: Cost
          revenue: Revenue

  # ---------------------------------------------------------------------------
  # WEBSITE ANALYTICS (REST API)
  # ---------------------------------------------------------------------------
  - id: website_traffic
    title: Website Traffic Overview
    description: Weekly website statistics
    provider: rest_analytics_api
    query:
      endpoint: stats/weekly
      params:
        start_date: "{{ (now - timedelta(days=7)).strftime('%Y-%m-%d') }}"
        end_date: "{{ now.strftime('%Y-%m-%d') }}"
        metrics: "pageviews,sessions,users,bounce_rate"
    render:
      type: table
      options:
        columns: [metric, value, change_pct]

  # ---------------------------------------------------------------------------
  # SUPPORT TICKETS (DATABASE)
  # ---------------------------------------------------------------------------
  - id: support_metrics
    title: Customer Support Metrics
    description: Support ticket statistics for the week
    provider: postgres_support
    query:
      text: |
        SELECT 
          status,
          COUNT(*) as ticket_count,
          AVG(EXTRACT(EPOCH FROM (resolved_at - created_at))/3600) as avg_resolution_hours
        FROM support_tickets
        WHERE created_at >= DATE_TRUNC('week', CURRENT_DATE)
        GROUP BY status
        ORDER BY 
          CASE status
            WHEN 'Open' THEN 1
            WHEN 'In Progress' THEN 2
            WHEN 'Resolved' THEN 3
            WHEN 'Closed' THEN 4
          END
    render:
      type: chart
      options:
        chart_type: bar
        x_field: status
        y_field: ticket_count
        title: Support Tickets by Status

  # ---------------------------------------------------------------------------
  # FINANCIAL SUMMARY (DATABASE)
  # ---------------------------------------------------------------------------
  - id: financial_summary
    title: Financial Summary
    description: Weekly financial performance
    provider: postgres_finance
    query:
      text: |
        SELECT 
          'Revenue' as metric,
          SUM(amount) as value,
          'USD' as currency
        FROM transactions
        WHERE transaction_type = 'sale'
          AND transaction_date >= DATE_TRUNC('week', CURRENT_DATE)
        UNION ALL
        SELECT 
          'Expenses' as metric,
          SUM(amount) as value,
          'USD' as currency
        FROM transactions
        WHERE transaction_type = 'expense'
          AND transaction_date >= DATE_TRUNC('week', CURRENT_DATE)
        UNION ALL
        SELECT 
          'Net Profit' as metric,
          SUM(CASE WHEN transaction_type = 'sale' THEN amount ELSE -amount END) as value,
          'USD' as currency
        FROM transactions
        WHERE transaction_date >= DATE_TRUNC('week', CURRENT_DATE)
    render:
      type: table
      options:
        columns: [metric, value, currency]
        headers:
          metric: Metric
          value: Amount
          currency: Currency

  # ---------------------------------------------------------------------------
  # INVENTORY STATUS (CSV)
  # ---------------------------------------------------------------------------
  - id: inventory_alerts
    title: Low Inventory Alerts
    description: Products below reorder threshold
    provider: csv_inventory
    query:
      path: inventory_status.csv
    render:
      type: table
      options:
        columns: 
          - product_code
          - product_name
          - current_stock
          - reorder_level
          - status
        headers:
          product_code: SKU
          product_name: Product
          current_stock: Stock
          reorder_level: Reorder Level
          status: Status

  # ---------------------------------------------------------------------------
  # GEOGRAPHIC DISTRIBUTION (DATABASE)
  # ---------------------------------------------------------------------------
  - id: sales_by_country
    title: Sales by Country
    description: International sales distribution
    provider: postgres_analytics
    query:
      text: |
        SELECT 
          country,
          COUNT(DISTINCT customer_id) as customers,
          COUNT(*) as orders,
          SUM(amount) as revenue
        FROM orders
        WHERE order_date >= DATE_TRUNC('week', CURRENT_DATE)
        GROUP BY country
        ORDER BY revenue DESC
    render:
      type: chart
      options:
        chart_type: bar
        x_field: country
        y_field: revenue
        title: Revenue by Country
        x_label: Country
        y_label: Revenue ($)

# Email configuration
email:
  to:
    - ceo@company.com
    - cfo@company.com
    - coo@company.com
  cc:
    - executive-team@company.com
  subject_template: "Weekly Executive Dashboard - Week of {{ generated_at.strftime('%B %d, %Y') }}"
  body_template: |
    Weekly executive dashboard for the week ending {{ generated_at.strftime('%B %d, %Y') }}.
    
    This report includes:
    - Key performance indicators with week-over-week comparison
    - Revenue and customer trends
    - Product performance analysis
    - Marketing campaign results
    - Support and operations metrics
    - Financial summary
    
    Please review the attached HTML report for complete details.

# Scheduling
schedule:
  cron: "0 9 * * 1"  # Every Monday at 9 AM
  timezone: America/New_York
  enabled: true
